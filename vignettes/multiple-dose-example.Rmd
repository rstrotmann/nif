---
title: "Example: Multiple-dose study"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{NIF data for a multiple-dose study}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
library(knitr)

knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  warning = FALSE
)
```

```{r setup, message=F}
library(dplyr)
library(tidyr)
library(ggplot2)
library(stringr)
library(nif)

theme_set(theme_bw())
```

# OVERVIEW

This vignette walks through the creation of a NONMEM Input Format (NIF) data set
for a multiple dose study (study 'RS2023-0022'), followed by some basic
exploratory analyses.

The fictional SDTM data for this study are included as part of the NIF package
(`examplinib_poc`). Custom SDTM data can be loaded using `read_sdtm()`.

## Study design

Study 'RS2023-0022' is a single-arm study in which subjects received multiple
doses of 'examplinib' (substance code 'RS2023').
The treatment duration is different across subjects. PK sampling was on Days 1
and 8 of the treatment period. The PK sampling schedule was rich in the initial
subset of subjects and sparse in the others.

## Study SDTM data

The  package provides the 'sdtm' class as a wrapper to keep all SDTM domain
tables of a clinical study together in one object. The `examplinib_poc` sdtm
object contains the DM, EX, PC and VS domains. Let's summarize the
`examplinib_poc` sdtm object for a high-level overview:

```{r, echo=T}
summary(examplinib_poc)
```

Note that in the EX domain, the administered drug is given as 'EXAMPLINIB' while
in PC, the corresponding analyte is 'RS2023'. The other analyte, 'RS2023487A' is
a metabolite.

# NIF DATA SET

Following the tutorial given in `vignette("nif-tutorial")`, we start with a
basic pharmacokinetic nif object from `examplinic_poc`:

```{r}
sdtm <- examplinib_poc

nif_poc <- new_nif() %>% 
  add_administration(sdtm, extrt = "EXAMPLINIB", analyte = "RS2023") %>% 
  add_observation(sdtm, domain = "pc", testcd = "RS2023", analyte = "RS2023", cmt = 2) %>% 
  add_observation(sdtm, domain = "pc", testcd = "RS2023487A", parent = "RS2023", cmt = 3) 
```

Let's add some further baseline data to our nif object. The serum creatinine
concentration can be used to calculate the individual baseline creatinine
clearance as an estimate for glomerular filtration rate (eGFR).

We first add baseline creatinine from the 'LB' domain using the generic
`add_baseline()` function. Then, creatinine clearance is calculated using
`add_bl_crcl()`. That function uses further covariate data (sex, age, race
and weight) and the Cockcroft-Gault formula by default. For further options, see
the documentation for `add_bl_crcl()`.

```{r}
nif_poc <- nif_poc %>% 
  add_baseline(sdtm, domain = "lb", testcd = "CREAT") %>% 
  add_bl_crcl()
```

The nif data set now includes both baseline creatinine and baseline creatinine
clearance:

```{r, comment="# "}
head(nif_poc, 3)
```

# EXPLORATION

## Demographics

For an initial overview on the distribution of baseline parameters in the study
population, the administered drugs, analytes, observations, etc., nif objects
can be inspected with the `summary()` function. After we have added baseline
creatinine clearance, the output also summarizes the number of patients with
normal renal function or impaired renal function:

```{r, comment="# "}
summary(nif_poc)
```

For a visual overview of the NIF data set `plot()` can be applied to the nif
summary object. Ignore the `invisible(capture.output())` construct in the below
code. Its purpose is to hide non-graphical output.

```{r, results='hide', fig.width=3, fig.height=3}
invisible(capture.output(
  plot(summary(nif_poc))
))
```

## Exposure

In this study, all `r nrow(subjects(nif_poc))` subject received the same dose
level:

```{r}
nif_poc %>%
  dose_levels() %>% 
  kable(caption="Dose levels")
```

However, there were subjects with dose reductions, as we can see when filtering
the nif data set for `EVID == 1` (i.e., administrations) and summarizing the
administered dose:

```{r}
nif_poc %>% 
  filter(EVID == 1) %>% 
  group_by(DOSE) %>% 
  summarize(n = n()) %>% 
  kable()
```

To identify the subjects with dose reductions, we can use the `dose_red_sbs()`
function provided by the nif package:

```{r, comment="# "}
nif_poc %>%
  dose_red_sbs()
```

Let's have a plot of the doses over time in these subjects: 

```{r fig.width=5, fig.height=2}
nif_poc %>% 
  filter(ID %in% (dose_red_sbs(nif_poc))$ID) %>% 
  filter(EVID == 1) %>% 
  ggplot(aes(x = TIME, y = DOSE, color = as.factor(ID))) + 
  geom_point() +
  geom_line() +
  theme(legend.position="none") 
```

We see that dose reductions happened at different times during treatment. Another
way of visualizing this is per the `mean_dose_plot()` function:

```{r fig.width=5, fig.height=3}
nif_poc %>%
  mean_dose_plot()
```

The upper panel shows the mean dose over time, and we can see that after ~Day 13,
the mean dose across all treated subjects drops due to dose reductions in some
subjects. To put this into context, the lower panel shows the number of subjects
on treatment over time, and we see that most subjects had treatment durations
of around 30 days. Note the fluctuations that indicate single missed doses in
individual subjects!

## PK sampling

The PK sampling time points in this study were:

```{r}
nif_poc %>% 
  filter(EVID == 0) %>% 
  group_by(NTIME, ANALYTE) %>% 
  summarize(n = n(), .groups = "drop") %>% 
  pivot_wider(names_from = "ANALYTE", values_from = "n") %>% 
  kable(caption = "Observations by time point and analyte")
```

From the different numbers of samplings per nominal time point, we guess that
only a subset of subjects had a rich sampling scheme. Let's identify those:

```{r, comment="# "}
nif_poc %>% 
  rich_sampling_sbs(analyte = "RS2023", max_time = 24, n = 6)
```

For details, see the documentation to `rich_sampling_sbs()`.

## Plasma concentration data

Let's plot the individual and mean plasma concentration profiles on Day 1 for
the parent, RS2023, and the metabolite, RS2023487A:

```{r fig.width=5, fig.height=3}
temp <- nif_poc %>% 
  filter(ID %in% (rich_sampling_sbs(nif_poc, analyte = "RS2023", n=4)))

temp %>%
  plot(dose = 500, points = TRUE, title = "Rich sampling subjects")
```

For single and multiple dose administrations separately: 

```{r fig.width=5, fig.height=3, warning=F, message=F}
temp <- temp %>% 
  index_rich_sampling_intervals()

temp %>% filter(RICH_N == 1) %>% 
  plot(analyte = "RS2023", mean = TRUE, title = "Single-dose PK")

temp %>% filter(RICH_N == 2) %>% 
  plot(analyte = "RS2023", title = "Multiple-dose PK", time = "NTIME", mean = T)
```

The above code made use of the helper function `index_rich_sampling_intervals()`
that identifies dosing intervals with rich PK sampling. See the documentation 
for details.

## Non-compartmental analysis

The nif package includes functions for non-compartmental PK analysis.
Essentially, `nca()` is a wrapper around `PKNCA::pk.nca()` from the
popular [PKNCA](https://cran.r-project.org/web/packages/PKNCA/index.html)
package.

```{r message = F, warning= F}
nca <- examplinib_poc_nif %>% 
  index_rich_sampling_intervals(analyte = "RS2023", min_n = 4) %>% 
  nca("RS2023", group = "RICH_N")

nca %>% 
  nca_summary_table(group = "RICH_N") %>% 
  kable()
```


