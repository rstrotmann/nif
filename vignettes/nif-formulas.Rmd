---
title: "NIF data definition using formulae"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{nif-formulas}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r  setup, message=F, warning=F}
library(dplyr)
library(nif)

nif_option(silent = TRUE)
```

# INTRODUCTION

The 'nif' package is mean to facilitate the creation of NONMEM Input Format
(NIF)- compliant data files for the analysis of longitudinal (time-varying)
clinical data. For a gentle introduction, see `vignette("nif-tutorial")`.

The overarching concept of the 'nif' package is to gradually build a data set,
sequentially adding administrations, observations, baseline data and covariates.
A typical workflow may look like this:

```{r}
sdtm <- examplinib_sad

nif <- nif() %>%
  add_administration(sdtm, "EXAMPLINIB") %>%
  add_observation(sdtm, "pc", "RS2023") %>%
  add_observation(sdtm, "pc", "RS2023487A") %>%
  add_baseline(sdtm, "lb", "CREAT")
```

The only time-varying data in this NIF data set are now the two pharmacokinetic
analytes, 'RS2023' and 'RS2023487A'. Real clinical data typically include many
time-varying observations, and for PK/PD analyses, and we might be interested in
adding further observation events to the nif data set. 

We can get an overview on all observation events included in the SDTM data like
so: 

```{r}
testcd(sdtm)
```

Likewise, we can get an overview on the treatments included in the SDTM data
with:

```{r}
treatments(sdtm)
```

# NIF FORMULAE

While the code for building a NIF data set that is shown above follows a clear
logic, sequentially addition data components, it may be sometimes preferable to
use more compact code. To this end, the 'nif' package allows the definition of
the data sources for an analysis data set using *formulae*:

```{r}
nif <- nif_auto(sdtm, RS2023 + RS2023487A ~ EXAMPLINIB)
```

The formulae provided as arguments to `nif_auto()` follow a consistent notation.
Observations are on the left hand side, and treatments (drug administrations)
are on the right hand side of the formula:

`analyte1 + analyte2 ~ treatment`

The number of analytes on the left hand side is not limited, but the right hand
side of the formula must specify a single administration that the observations 
relate to.

We have specified two pharmacokinetic observations ('RS2023' and 'RS2023487A').
However observations may be of any kind, e.g., from the clinical lab (LB), vital
sign (VS), ECG (EG), or any other SDTM domain.

Note that the above code includes only one formula, but if there are multiple
drugs administered with associated observations, multiple formulae can be
provided as arguments to `nif_auto()`.

Inspecting the resulting nif object, we can see that `nif_auto()` has also added
baseline serum creatinine data and derived the baseline creatinine clearance and
renal function category from it:

```{r}
head(nif, 3)
```

`nif_auto()` will further attempt to infer the baseline hepatic function
category as per the NCI ODWG classification from baseline bilirubin and AST
data. In this example SDTM data set, these parameters are not part of the LB
domain, though.

