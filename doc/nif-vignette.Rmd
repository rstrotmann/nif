---
title: "Creating NIF files from SDTM data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Creating NIF files from SDTM data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "> "
)
```

This is a basic tutorial on using the `nif` package to create NONMEM Input File
(NIF) data sets from Study Data Tabulation Model- (SDTM) formatted data.

The package is intended to facilitate creating the input data in the format
required for population PK or PK/PD modeling.
The source data typically come from different SDTM tables, including but not 
limited to:
baseline demographic and vital sign, drug exposure, and pharmacokinetic
concentration data.

The first part of this tutorial describes how to import SDTM data into a `sdtm`
object, and some initial explorations based on the SDTM data.

The second part of this tutorial walks through the generation of a NIF data set
from SDTM data tables and some general exploratory analyses.

This tutorial contains live code that depends on the following R packages:

```{r setup, message=F, warning=F}
library(tidyr)
library(dplyr)
library(stringr)
library(knitr)
library(nif)
```

# SDTM DATA

## Import SDTM data 

As a minimum, the following SDTM domains are
expected to create a basic NIF file:

* DM - demographic data, mostly age, sex and other variables per subject
* VS - vital signs, particularly weight and height at enrollment, per subject
* EX - exposure information for the administered drugs, e.g., the time of
    administration, dose, etc.
* PC - pharmacokinetic concentrations for the analytes associated with the 
    administered drugs
    
In the most common use case, the respective SDTM data files, e.g., as *.sas7bdat
files, are copied into one folder (in the below example into `path/to/sdtm/data`),
and can then be loaded using:

```{r, eval=FALSE, echo=T}
read_sdtm_sas("path/to/sdtm/data")
```

Based on the above, the minimum required SDTM files are `dm.dat7bdat`,
`vs.dat7bdat`, `ex.dat7bdat` and `pc.dat7bdat`. However, if additional
covariates from AE, LB or any other SDTM domain are to be added, an explicit
list of the domains can be provided to the loading function, e.g., 

```{r, eval=FALSE, echo=T}
read_sdtm_sas("path/to/sdtm/data", "dm", "vs", "ex", "pc", "lb", "ae")
```

The return value of the function is a `sdtm` object.

## SDTM objects

`sdtm` objects are essentially lists of the SDTM domains from a particular
clinical study plus some metadata. The most common way of creating `sdtm`
objects is by importing the SDTM data using `read_sdtm_sas()` or
`read_sdtm_xpt()` as shown above. 

This package includes sample SDTM data sets for demonstration purposes. These
data do not come from actual clinical studies but are fully synthetic data sets
from a fictional single ascending dose (SAD) study (`examplinib_sad`), a
fictional typical food effect (FE) study (`examplinib_fe`), and a fictional
single-arm proof-of-concept (POC) study with multiple-dose administrations
(`examplinib_poc`).

The original SDTM data can be retrieved from `sdtm` objects by accessing the
individual SDTM domains like demonstrated below for the DM domain of the
`examplinib_fe` data object.

```{r}
examplinib_fe$domains[["dm"]] %>% head()
```

The most relevant domains, "dm", "vs", "ex" and "pc", can also be accessed
directly, e.g.:

```{r}
dm <- examplinib_fe$dm
```

Printing an `sdtm` object shows some of its basic properties:

```{r}
examplinib_fe
```

Note the 'Treatment-to-analyte mappings' and 'Parent-to-metabolite mapping'
tables, we will get back to this when creating a NIF data set from these SDTM
data.

In addition to a general overview, general demographic data for individual 
subjects can be extracted as shown below: 

```{r}
examplinib_fe %>% subject_info("20230004001050001")
```

## SDTM suggestions

SDTM data may be incomplete, e.g., when emerging data that have not yet been
fully cleaned are analyzed before data base lock. In addition, study-specific
data may be encoded in a non-standard way, e.g., information on study parts,
cohorts, treatment conditions, etc..

Such data fields may need study-specific considerations and manual imputations
during the creating of the NIF data set. To help deciding which study-specific
factors need to be addressed, the `nif` package includes functions to explore
the SDTM data.

As a starting point, `suggest()` can provide useful suggestions for 
a `sdtm` object:

```{r}
suggest(examplinib_fe)
```

In the case of `examplinib_fe`, there are different treatment arms defined in 
the DM domain that should probably be included as covariates in the NIF file
(see suggestion 1). A respective variable within the NIF data set will be
programmed once a basic NIF file has been generated (see below).

Also, the SDTM data do not provide a relation between treatments and analytes
(see suggestion 2). The parent drug name in the SDTM field `EXTRT` (i.e.,
"EXAMPLINIB") is different from the respective analyte for the parent compound
as specified in the field `PCTESTCD` (i.e., "RS2023"). This is a common
situation in data from clinical studies. However, to correctly associate
pharmacokinetic concentrations with the administration of the corresponding
drug, a link needs to be provided between the treament and the analyte.
Similarly, metabolites (e.g., "RS2023487A") need to be linked to their parent
compound - particularly if muliple drugs and metabolites are included in the
data set.

Both are addressed in the following.

### Analyte mappings

Often, the names for the treatments as listed in the `EXTRT` field of EX do not
directly correspond to the names of the respective (parent) analytes codes used
in the PC domain (i.e., in the `PCTESTCD` field).

To establish these relationships, treatment-analyte mappings must be added to 
the `sdtm` object with `add_analyte_mapping()`. In this sample case, the analyte
"RS2023" refers to the (parent) plasma concentration for the drug "EXAMPLINIB." 

To establish the relationships betwen metabolites and their parent copounds, 
`add_metabolite_mapping()` can be used. In the sample data, the `PCTESTCD` of
"RS2023487A" represents a metabolite of "RS2023":

```{r}
sdtm_expl <- examplinib_fe %>% 
  add_analyte_mapping("EXAMPLINIB", "RS2023") %>% 
  add_metabolite_mapping("RS2023", "RS2023487A")
```

# NIF DATA SETS

## Creating NIF data sets

In addition to re-arranging and joining these SDTM data tables, certain standard
data imputations are automatically performed by the functions provided in this
package, some of which are discussed in more detail in the vignette "Imputations
and assumptions used by make_nif()".


The following section details how to create NIF files from an `sdtm` object.

### Basic NIF file

Most steps in the generation of a basic NIF file from an `sdtm` object are
automated in the `make_nif()` function. The resulting `nif` object is 
a data table with individual rows for individual administrations and
observations and follows the naming conventions summarized in 
[Bauer, CPT Pharmacometrics Syst. Pharmacol. (2019)](https://doi.org/10.1002/psp4.12404).

Standard demographic information including SEX, AGE, RACE is taken from the DM 
domain and merged into the data table. Baseline WEIGHT and HEIGHT are taken from 
the VS domain.

```{r}
nif_expl <- make_nif(sdtm_expl, silent=TRUE)
```

The output of the above code informs that there may be pharmacokinetic data for
multiple specimens in the PC domain, e.g., "PLASMA" and "URINE" or "FECES".
As no specimem was defined, `make_nif()` takes the most likely ("PLASMA").
Alternatively, the specimen of interest can be explicitly provided
(see `?make_nif()` for details).

Also, a data cut-off was applied that reflects the date and time of the last
observation. This may be most relevant in multiple-dose studies where further
administrations may be recorded after the last oberservation. These
administration events are excluded from the NIF file.

### Study-specific covariates

In many clinical studies, participants are treated in subgroups, e.g.,
dose groups, formulations, co-administered drug interaction
perpetrators. While dose is automatically included as a continuous covariate per
the EX domain, other categorical covariates may need to be derived, e.g., from the
study arm field.

The inclcuded sample study is a food effect study in which participants received
the test drug, EXAMPLINIB, fasted or fed in a randomized sequence (see `ACTARM`
and `ACTARMCD` in the output of `suggest()` above). Often, relevant fields
for consideration are `EPOCH` and `ACTARMCD`:

```{r}
nif_expl %>% 
  as.data.frame() %>% 
  distinct(EPOCH, ACTARMCD, ACTARM)
```

To create a `FASTED` covariate for the sample data set, first the period number
is derived from the `EPOCH` field, and then the current `ACTARM` in that
treatment period is decoded to `FASTED`:

```{r}
nif_expl <- make_nif(sdtm_expl, silent=T) %>%
  mutate(PERIOD=str_sub(EPOCH, -1, -1)) %>% 
  mutate(TREATMENT=str_sub(ACTARMCD, PERIOD, PERIOD)) %>% 
  mutate(FASTED=case_when(TREATMENT=="A" ~ 1, .default=0))
```

Note the `silent=T` modifier that omits all messages from `make_nif()`.

The NIF file has now the additional fields `PERIOD`, `TREATMENT` and `FASTED`,
see the first few lines of the the data:

```{r}
nif_expl %>%
  select(USUBJID, PERIOD, TREATMENT, FASTED, TIME, EVID, AMT, ANALYTE, DV) %>% 
  arrange(USUBJID, PERIOD, TREATMENT, FASTED, TIME, EVID, ANALYTE) %>% 
  as.data.frame() %>% 
  head() %>% 
  kable()
```

## Graphical exploration

NIF objects allow basic ploting functionality using `plot()`, directly applied
to the object. The below shows some examples for common exploratory tasks (for 
more detail, refer to `?plot.nif()`).

Obviously, more complex custom plots (or other analyses) can be done manually on
the `nif` data. Note that the `nif` object must be converted to a data frame for
this purpose (i.e., using `as.data.frame()`):

In the simplest exploratory plot, all analytes are shown:

```{r, warning=F, fig.width=4, fig.height=3}
plot(nif_expl)
```

Modifiers to the `plot()` function allow common adjustments. To show, e.g., the
food effect on the parent compound, "RS2023" in individual subjects, limiting
the time axis to 24 h and showing the nominal time instead of the actual time:

```{r, warning=F, fig.width=4, fig.height=3}
plot(nif_expl, analyte="RS2023", group="FASTED", max_x=24, mean=F, points=T, nominal_time=T)
```

The following shows the mean plasma concentration profiles over 24 h by food
status:

```{r, warning=F, fig.width=4, fig.height=3}
plot(nif_expl, analyte="RS2023", group="FASTED", max_x=24, mean=T)
```

There are further display options, refer to `?plot.nif()` for details.

For a quick overview, use `nif_viewer()` to show individual subjects
interactively: 

```{r, eval=FALSE, echo=T}
nif_viewer(nif_expl)
```

